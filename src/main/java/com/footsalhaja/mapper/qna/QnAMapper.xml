<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="com.footsalhaja.mapper.qna.QnAMapper">

	<!-- Create QnABoard -->	 
	 <insert id="insertQnABoard" >
		 INSERT INTO QnABoard 
		 		(  category,   title,    content , member_userId )
		 VALUES 
		 		(#{category}, #{title}, #{content}, #{userId}  );
	 </insert>
	 <update id="updateMyQnABoard">
	 	UPDATE QnABoard SET
	 		title = #{title},
	 		content = #{content}		
	 	WHERE
	 		qnaId = #{qnaId}
	 </update>
	 
	 <select id="myQnAList" resultType="com.footsalhaja.domain.qna.QnADto">
	 	SELECT 
	 		q.qnaId,
	 		q.category,
	 		q.title,
	 		q.content,
	 		q.status,
	 		m.userId,
	 		m.nickName
	 	FROM 
	 	 	QnABoard q
	 	LEFT JOIN member m 
	 	ON q.member_userId = m.userId 	
	 	WHERE
	 		m.userId = #{userId}
	 	
	 	ORDER BY 
	 		qnaId DESC 
	 	LIMIT
	 		#{offset}, #{records}
	 </select>
	 
	 <select id="selectQnAListByStatusDone" resultType="com.footsalhaja.domain.qna.QnADto">
	 	SELECT 
	 		q.qnaId,
	 		q.category,
	 		q.title,
	 		q.content,
	 		q.status,
	 		q.member_userId AS userId,
	 		q.insertDatetime,
	 		COUNT(distinct l.qnaLikeId) AS likeCount,
	 		COUNT(DISTINCT r.qnaReplyToAnswerId) AS replyCount
	 		
	 	FROM QnABoard q
	 	LEFT JOIN QnABoardLike l ON q.qnaId = l.qnaId
	 	LEFT JOIN QnAReplyToAnswer r ON q.qnaId = r.qnaId
	 	WHERE
	 		q.status = #{status} 
	 	AND 
	 	(
		<trim prefixOverrides="OR">
			<if test="type == 'all' or type == 'title'">
			OR q.title LIKE #{keyword}
			</if>
			
			<if test="type == 'all' or type == 'content'">
			OR q.content LIKE #{keyword}
			</if>
			
			<if test="type == 'all' or type == 'userId'">
			OR q.member_userId LIKE #{keyword}
			</if>
		</trim> 
		) 	
		GROUP BY q.qnaId
	 	ORDER BY q.qnaId DESC
	 	LIMIT #{offset}, #{records}
	 </select>
	 
	 <select id="countAllQnAByUserId" resultType="int">
	 	SELECT 
	 		COUNT(*)
	 	FROM 
	 	 	QnABoard q
	 	LEFT JOIN member m 
	 	ON q.member_userId = m.userId 	
	 	WHERE
	 		m.userId = #{userId}
	 </select>
	 
	<select id="selectMyQnAListByUserId" resultType="com.footsalhaja.domain.qna.QnADto">
	 	SELECT 
	 		q.qnaId,
	 		q.category,
	 		q.title,
	 		q.content,q.
	 		q.status,
	 		m.userId AS member_userId,
	 		m.nickName AS member_nickName
	 	FROM 
	 	 	QnABoard q
	 	LEFT JOIN QnABoardLike l ON q.qnaId = l.qnaId
	 	LEFT JOIN member m ON q.member_userId = m.userId
	 	WHERE 
	 		m.userId = #{userId} 
	 	ORDER BY 
	 		q.qnaId DESC 
	</select>

	<select id="selectMyQnAGetByQnAIdAndUserId" resultType="com.footsalhaja.domain.qna.QnADto">
		SELECT 
	 		q.qnaId,
	 		q.category,
	 		q.title,
	 		q.content,
	 		q.status,
	 		q.insertDatetime,
	 		m.userId,
	 		r.qnaReplyId,
	 		COUNT(DISTINCT l.qnaLikeId) AS likeCount
	 	FROM 
	 	 	QnABoard q
	 	LEFT JOIN member m   ON q.member_userId = m.userId
	 	LEFT JOIN QnAReply r ON q.member_userId = r.userId
	 	LEFT JOIN QnABoardLike l ON q.qnaId = l.qnaId
	 	WHERE 
	 		m.userId = #{userId} AND q.qnaId = #{qnaId}
	 	
	</select>	
	
	
	<select id="selectFAQList" resultType="com.footsalhaja.domain.qna.FAQDto">
		SELECT 
			faqId,
			title,
			content
		FROM
			FAQ	
	</select>
	
	<select id="selectAllQnAList" resultType="com.footsalhaja.domain.qna.QnADto">
		SELECT 
	 		q.qnaId,
	 		q.category,
	 		q.title,
	 		q.content,
	 		q.status,
	 		q.member_userId AS userId,
	 		q.insertDatetime,
	 		COUNT(DISTINCT l.qnaLikeId) AS likeCount
	 	FROM 
	 	 	QnABoard q
	 	LEFT JOIN QnABoardLike l ON q.qnaId = l.qnaId 	
	 	WHERE
		<trim prefixOverrides="OR">
			<if test="type == 'all' or type == 'title'">
			OR title LIKE #{keyword}
			</if>
			
			<if test="type == 'all' or type == 'content'">
			OR content LIKE #{keyword}
			</if>
			
			<if test="type == 'all' or type == 'userId'">
			OR member_userId LIKE #{keyword}
			</if>
		</trim>
		Group By q.qnaId
	 	ORDER BY q.qnaId DESC
	 	LIMIT #{offset}, #{records}
	</select>
	
	<select id="countAllQnA" resultType="int">
		SELECT 
	 		COUNT(*)
	 	FROM 
	 	 	QnABoard 
	 	WHERE
		<trim prefixOverrides="OR">
			<if test="type == 'all' or type == 'title'">
			OR title LIKE #{keyword}
			</if>
			
			<if test="type == 'all' or type == 'content'">
			OR content LIKE #{keyword}
			</if>
			
			<if test="type == 'all' or type == 'userId'">
			OR member_userId LIKE #{keyword}
			</if>
		</trim> 	
	</select>
	
		<select id="countAllQnAByDone" resultType="int">
		SELECT 
	 		COUNT(*)
	 	FROM 
	 	 	QnABoard 
	 	WHERE
	 		status = #{status} AND
	 	(
	 	
		<trim prefixOverrides="OR">
			<if test="type == 'all' or type == 'title'">
			OR title LIKE #{keyword}
			</if>
			
			<if test="type == 'all' or type == 'content'">
			OR content LIKE #{keyword}
			</if>
			
			<if test="type == 'all' or type == 'userId'">
			OR member_userId LIKE #{keyword}
			</if>
		</trim> 	
		)
		
	</select>
<!-- ###################################################################### -->
	<!-- 좋아요 기능추가  -->
	<select id="selectQnABoardLikeCount" resultType="int">
		SELECT 
			COUNT(*) likeCount
		FROM 
			QnABoardLike
		WHERE 
			qnaId = #{qnaId} AND userId = #{loggedinId}
	</select>
	<select id="countAllLikeByQnAId" resultType="int">
		SELECT 
			COUNT(qnaLikeId) likeCount
		FROM 
			QnABoardLike
		WHERE 
			qnaId = #{qnaId}
	</select>
	<insert id="insertQnABoardLikeCount">
		INSERT INTO QnABoardLike (qnaId, userId)
		VALUES (#{qnaId}, #{loggedinId})
	</insert>
	<delete id="deleteQnABoardLikeCount">
		DELETE FROM QnABoardLike
		WHERE qnaId = #{qnaId} AND userId = #{loggedinId}
	</delete>
<!-- ###################################################################### -->
	<insert id="insertQnAReply">
		<!-- //qnaReplyId,qnaId,userId,writer,content,insertDatetime -->
		INSERT INTO QnAReply (qnaId, userId, writer, content)
		VALUES( #{qnaId}, #{userId}, #{writer}, #{content} )
	</insert>
	
	<update id="updateAnswerByAnswerId">
		UPDATE QnAReply SET
		content = #{content}
		WHERE qnaReplyId = #{answerId}
	</update>
	
	<update id="updateReplyById">
		UPDATE QnAReplyToAnswer SET
		content = #{content}
		WHERE qnaReplyToAnswerId = #{qnaReplyToAnswerId}
	</update>
	<select id="selectQnAReply" resultType="com.footsalhaja.domain.qna.QnAReplyDto">
		<!-- //qnaReplyId,qnaId,userId,writer,content,insertDatetime -->
		SELECT 
			qnaReplyId,
			qnaId,
			userId,
			writer,
			content,
			insertDatetime
		FROM 
			QnAReply
		WHERE 
			qnaId = #{qnaId}
	</select>
	
	<insert id="insertQnAReplyToAnswer">
		<!-- //qnaReplyToAnswerId, qnaReplyId, qnaId, writer, content, userId, insertDatetime -->
		INSERT INTO QnAReplyToAnswer (qnaReplyId, qnaId, writer, content, userId)
		VALUES( #{qnaReplyId}, #{qnaId}, #{writer}, #{content}, #{userId} )
	</insert>
	
	<select id="selectReplyList" resultType="com.footsalhaja.domain.qna.QnAReplyToAnswerDto">
		SELECT 
			qnaReplyToAnswerId,
			qnaReplyId,
			qnaId,
			userId,
			(writer = #{userId}) editable,
			content,
			insertDatetime
		FROM 
			QnAReplyToAnswer
		WHERE 
			qnaReplyId = #{answerId}
	</select>
	
	<select id="selectQnAReplyById" resultType="com.footsalhaja.domain.qna.QnAReplyToAnswerDto">
		SELECT 
			qnaReplyToAnswerId,
			qnaReplyId,
			qnaId,
			userId,
			writer,
			content,
			insertDatetime
		FROM 
			QnAReplyToAnswer
		WHERE 
			qnaReplyToAnswerId = #{replyId}
	</select>
	
	<select id="selectQnAReplyToAnswerList" resultType="com.footsalhaja.domain.qna.QnAReplyToAnswerDto">
		<!-- //qnaReplyToAnswerId, qnaReplyId, qnaId, writer, content, userId, insertDatetime -->
		SELECT 
			qnaReplyToAnswerId,
			qnaReplyId,
			qnaId,
			userId,
			writer,
			content,
			insertDatetime
		FROM 
			QnAReplyToAnswer
		WHERE 
			qnaReplyId = #{qnaReplyId}
	</select>

	<update id="updateQnAStatus">
		UPDATE QnABoard SET
			status = #{status}
		WHERE qnaId = #{qnaId} 	
	</update>
	
	<delete id="deleteAnswerByAnswerId">
		DELETE FROM QnAReply
		WHERE qnaReplyId = #{qnaReplyId}
	</delete>
	
	<delete id="deleteQnAReplyByReplyId">
		DELETE FROM QnAReplyToAnswer
		WHERE qnaReplyToAnswerId = #{qnaReplyToAnswerId}
	</delete>
	<delete id="deleteQnAReplyByAnswerId">
		DELETE FROM QnAReplyToAnswer
		WHERE qnaReplyId = #{qnaAnswerId}
	</delete>
	<delete id="deleteAllQnAReplyById">
		DELETE FROM QnAReplyToAnswer
		WHERE qnaId = #{qnaId}
	</delete>
	<delete id="deleteAnswerBYqnaId">
		DELETE FROM QnAReply
		WHERE qnaId = #{qnaId}
	</delete>
	<delete id="deleteQnA">
		DELETE FROM QnABoard
		WHERE qnaId = #{qnaId}
	</delete>
	<delete id="deleteLikesByqnaId">
		DELETE FROM QnABoardLike
		WHERE qnaId = #{qnaId}
	</delete>
 </mapper>